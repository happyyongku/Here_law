pipeline {
    agent any
    environment {
        DOCKER_CREDENTIALS_ID = '53c0e6f0-2c1e-43b2-a1a1-3d3e56fd1cae'
        GITLAB_CREDENTIALS_ID = '2f379a74-002d-471d-a051-6bd615828532'
        SSH_KEY='f7745d84-3b92-4a34-9da8-ab8b48c2f6bf'
    }
    stages {
        stage('Checkout or Update Code'){
            steps {
                git url: 'https://lab.ssafy.com/s11-bigdata-dist-sub1/S11P21B109.git', branch: 'master', credentialsId: env.GITLAB_CREDENTIALS_ID
            }
        }
        stage('Copy docker-compose File to EC2') {
            steps {
                script {
                    sshagent (credentials: [env.SSH_KEY]) {
                        sh 'scp -o StrictHostKeyChecking=no docker-compose-ec2.yml ubuntu@j11b109.p.ssafy.io:/home/ubuntu/j11b109/docker-compose-ec2.yml'
                        sh 'scp -o StrictHostKeyChecking=no nginx/nginx.conf ubuntu@j11b109.p.ssafy.io:/home/ubuntu/j11b109/nginx/nginx.conf'
                        sh 'scp -o StrictHostKeyChecking=no DB/init.sql ubuntu@j11b109.p.ssafy.io:/home/ubuntu/j11b109/init.sql'
                    }
                }
            }
        }
        stage('Docker login') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDENTIALS_ID) {
                        echo 'Logged in Dockerhub'
                    }
                }
            }
        }
        stage('Create .env') {
            steps {
                script{
                    sshagent (credentials: [env.SSH_KEY]) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no ubuntu@j11b109.p.ssafy.io "cd /home/ubuntu/j11b109 &&
                        cat > .env << EOF
DB_DOMAIN=$DB_DOMAIN
DB_PORT=$DB_PORT
DB_PORT_SPRING=$DB_PORT_SPRING
DB_PORT_FASTAPI=$DB_PORT_FASTAPI
DB_NAME=$DB_NAME
DB_USERNAME=$DB_USERNAME
DB_PASSWORD=$DB_PASSWORD
ELA_PASSWORD=$ELA_PASSWORD
WT_SECRET=$JWT_SECRET
JWT_EXPIRATION=$JWT_EXPIRATION
MAIL_HOST=$MAIL_HOST
MAIL_PORT=$MAIL_PORT
MAIL_USERNAME=$MAIL_USERNAME
MAIL_PASSWORD=$MAIL_PASSWORD
EMBEDDER_URL=$EMBEDDER_URL
SESSION_TIMEOUT=$SESSION_TIMEOUT
MAX_SESSIONS_PER_USER=$MAX_SESSIONS_PER_USER
SESSION_CLEANUP_INTERVAL=$SESSION_CLEANUP_INTERVAL
ACCESS_TOKEN_EXPIRATION_MINUTES=$ACCESS_TOKEN_EXPIRATION_MINUTES
FASTAPI_SERVER_PORT=$FASTAPI_SERVER_PORT
API_KEY=$API_KEY
EOF
                        '''
                    }
                }
            }
        }
        stage ('Build and Push Docker Images') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDENTIALS_ID) {
                    // Build spring image
                    dir('backend/spring') {
                        sh 'chmod +x gradlew'
                        sh 'docker build -t happyyongku/j11b109:spring .'
                        sh 'docker push happyyongku/j11b109:spring'
                    }
                    // Build FastAPI image
                    dir('backend/fastapi_ec2') {
                        sh 'docker build -t happyyongku/j11b109:fastapi .'
                        sh 'docker push happyyongku/j11b109:fastapi'
                    }
                    // Build React image
                    dir('frontend/here_law') {
                        sh 'docker build -t happyyongku/j11b109:react .'
                        sh 'docker push happyyongku/j11b109:react'
                    }
                    // Build Nginx image
                    dir('nginx') {
                        sh 'docker build -t happyyongku/j11b109:nginx .'
                        sh 'docker push happyyongku/j11b109:nginx'
                    }
                    // Build postgreSQL image
                    dir('DB') {
                        sh 'docker build -t happyyongku/j11b109:postgres .'
                        sh 'docker push happyyongku/j11b109:postgres'
                    }
                    }
                }
            }
        }
        
        stage('Deploy EC2 and NGINX') {
            steps {
                script {
                    echo 'Deploying EC2 and NGINX ...'
                    sshagent (credentials: [env.SSH_KEY]) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no ubuntu@j11b109.p.ssafy.io "cd /home/ubuntu/j11b109 &&
                            echo "shutting down old containers" &&
                            docker-compose -f docker-compose-ec2.yml down &&
                            echo "start pull" &&
                            docker-compose -f docker-compose-ec2.yml pull &&
                            echo "start up" &&
                            docker-compose --env-file .env -f docker-compose-ec2.yml up -d" &&
                            echo "print env" &&
                            env | grep DB_
                        '''
                    }
                }
            }
        }

        // stage('Run DB migration') {
        //     steps {
        //         script {
        //             sh 'sleep 15'
        //             sh 'docker exec -i j11b109_postgres_1 psql -U $DB_USERNAME -d postgres -f /docker-entrypoint-initdb.d/init.sql'
        //         }
        //     }
        // }

        // stage('Run postgres') {
        //     steps {
        //         script {
        //             sh 'docker restart j11b109_postgres_1'
        //         }
        //     }
        // }
    }
    post {
        success {
            echo 'Successful Built and Deployed'
            sh 'echo "successed yongku"'
        }
        failure {
            echo 'Build or Deployment failed'
        }
    }
}